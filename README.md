# SmartLock_QR
Original Smartlock via QRcode

---

情 報 工 学 実 験 報 告 書  
III  
実 験 題 目 でスマートロックをつくる  
Raspberry Pi  
実 施 日  
月 日 月 日  
1 11 1 13,14  
月 日 月 日  
1 17,18 1 20,21  
月 日 月 日  
1 24,25 1 27,28  
月 日 月 日  
1 31 2 1  
報告書作成日  
年 月 日  
2022 2 1  
報 告 者 平野悠人  
419024  
三重大学 工学部 情報工学コース概要  
1  
今回、自由課題のテーマとして「 でスマートロックをつくる」として設定した。  
Raspberry Pi  
主目的  
• でサーボモーターを回して(cid:20276)開閉機構を作成する。その過程で  
に触れ、これまで得た知識を実践する場として実験を行う。  
Raspberry Pi Raspberry Pi  
考案背景  
• 昨年に履修した集中講義「実践ソフトウェア開発演習」で、 デバイス を用い  
たシステム設計を行った。その経験をもとにさらなる演習を行いたいと考えた。  
IoT (m5stick)  
また、以下の手順によって実験を行っていく  
の準備  
• Raspberry Pi  
サーボモータを用いたロック機構の考案  
•  
ロック機構に用いるパーツの作成 プリンタ  
• (3D )  
データログを構築  
•  
セキュリティを強化 コード  
• (QR , NFC, RSA)  
なお、今回作成するシステムの全体像は以下の図 である。  
1  
外側 部屋側  
Webサーバー  
Webカメラ  
サーボモーター  
開閉ボタン  
ボタン(カメラ起動用)  
Rasberry Pi  
開閉操作 ログの記録 IoT機器の入出力  
ハード面 ソフト面  
(a) (b)  
図 システムの構成  
1:  
ハード面について  
• 開閉操作には コードによる認証方式を採用した。負荷軽減のため カメラ起動用の  
ボタンを押したのちに、認証を受け付け、(cid:20276)の開閉を行う。  
QR Web  
また、部屋から出る際は開閉ボタンを押すことで(cid:20276)の開閉を行う。  
ソフト面について  
• 基本的にどの操作も を介して動作させる。  
WebAPI  
また提出物としては、このレポートと作成した各種データのアーカイブを用意した。アーカイ  
ブには各々の説明を記述した が添付してある。  
”README.md”  
2実践内容の報告  
2  
の準備  
2.1 Raspberry Pi  
以下の作業を実行した。  
公式ページにてダウンロードした イメージを を使用して に イ  
• メージを書き込む OS Etcher.io microSD OS  
を起動しアップデート等の初期設定を行う  
• Raspberry Pi  
リモートデスクトップの設定  
• 自宅の から へキーボードとマウスを繋ぎ変えるのが手間なので、自宅の  
から を操作できるように設定 参考文献  
PC Raspberry Pi  
PC Raspberry Pi ( [1])  
セキュリティ対策  
• ログイン設定の見直し のデフォルトからの変更 接続設定の見直し ポー  
ト番号の変更、パスワード認証から 公開(cid:20276)認証方式に 参考文献  
(id,password ),SSH (  
RSA ) ( [2])  
接続の実行  
• S自S宅Hの 側から直接ファイル操作を行えるように 参考文献  
PC ( [3])  
開発環境 を介して 接続できるよう設定  
• ある程度使VいSC慣odれeている SSH で作業が行えるように 参考文献  
VSCode ( [4])  
これで に電源を供給するだけで自宅の からプログラムコードの作成から実行  
までを行えるようになった  
Raspberry Pi PC  
.  
サーボモータを用いたロック機構の考案  
2.2  
現在、既製品としてスマートロックが各種販売されている。しかし、どれも高価であり購入し  
てシステムを模倣することはかなわないため、自分なりにシステムを考案してみることとした。  
以下の図 が考案したドアのサムターン開閉システムである。  
2  
開錠操作  
-90 +90 +45 +45 -90  
OPEN  
待機状態 待機状態  
+90 -90 -45 -45 +90  
LOSE  
施錠操作 待機状態 待機状態  
図 サムターン開閉システム  
2:  
突起が二つ取り付けてある円形のパーツがのちに プリンターで作成する部品である。基本  
的には操作したい回転方向 開錠時は時計回り、施錠時は反時計回り に 度回転させれば、開  
3D  
( ) 90  
3閉操作を行うことができる。しかし、そのままでは誤作動があった場合に(cid:20276)を使った手動での開  
閉ができない。 通電状態ではサーボモータの角度が固定されているため、スマートロック機構を  
破損する恐れがある したがって、開閉操作をしても回転部品としない位置 待機状態 に移動さ  
(  
せる挙動が必要となる。  
) ( )  
ロック機構に用いるパーツの作成 プリンタ  
2.3 (3D )  
先に説明したロック機構を実現するために プリンタでパーツを作成する。作成するパーツ  
は以下の 点である。壁側に固定するために今回はネオジム磁石を用いる。  
3D  
2  
サムターンを回転させるパーツ  
• サムターンを回転させる突起および、サーボーモータ側の羽を接続するくぼみをもつ  
サーボモーターを壁側に固定するパーツ  
• 「サムターンを回転させるパーツ」を包み込むパーツで、サーボーモータ本体を固定する  
穴、パーツ本体を壁側に固定する際にネオジム磁石を入れ込む用のくぼみをもつ  
の作成には を使用した。以下の図 が作成した である。  
3DCAD Autodesk Fusion360 3 3DCAD  
図 作成した  
3: 3DCAD  
4データログを構築  
2.4  
ライブラリ を用いてデータモデルの構築と の作成を行う 参考文献 。作成し  
たデータモデルは以下の表 である。また、完成したプログラムコードは に記述  
Peewee API ( [5])  
した。  
1, 2 ”Server.py”  
表 開閉データのログ  
1: ”DataModel”  
どの要素からの操作か 物理ボタン コード  
操作時刻 最新ログ取得用のトリガーの役割も  
dev id ( ,QR ,WebAPI)  
現在の(cid:20276)の状態  
send date ( )  
任意のメモ  
is open  
comment  
表 (cid:20276)の開閉命令  
2: ”KeyOperand”  
操作時刻 最新ログ取得用のトリガーの役割も  
開閉の要望を記録 何も命令がないときは  
send date ( )  
key ope ( ”nobe”)  
また、登録した に関しては以下の表 で示す。  
API 3  
表 登録  
3: API  
されたデータを に追加  
の最新データをかえす  
’/add’ HTTP POST ”DataModel”  
されたデータを に追加  
’/get’ ”DataModel”  
の最新データをかえす  
’/add key’ HTTP POST ”KeyOperand”  
データモデルを引き渡し、 ページの表示 のみ  
’/get key’ ”KeyOperand”  
’/’ Web (”DataModel” )  
に接続された際に表示される の ページも簡易的に作成した 図 。開閉データの  
ログ が確認できる。また、 が簡易的にできるよう、関数化し  
’/’ html Web ( 4)  
た 。  
”DataModel” HTTP POST, GET  
この段階で大まかなスマートロックシステムが出来上がった。実行手順としては  
(”send data.py”)  
を実行  
機能の開始  
1. ”Server.py”  
webAPI  
別のターミナルで を実行  
の操作を開始  
2. ”servo 1.py”  
RaspberryPi  
である。また、使用できる機能は以下で示す。  
数秒おきに のデータベースを参照し、命令があれば指定された開閉作業を実  
• 行する ”KeyOperand”  
物理ボタン が押されたら、開閉作業を実行する  
• ” 1”  
物理ボタン が押されたら、 を正常終了する  
• ” 3” ”servo.py”  
の関数にて開閉命令を出せる  
• ”send data.py”  
5図 簡易的な ページ  
4: Web  
この仕組みによって を用いたシンプルな遠隔操作が可能となった。また、今回は  
サーバーをローカルに設置したが、 等のサービスを利用すれば外出先からも ページ  
HTTP POST  
を閲覧することができる。  
Heroku Web  
工夫点として、(cid:20276)の開閉状態をフラグとして管理し、同じ動作を 回行わないようにした  
など 。そのため、物理開閉ボタンは つで実装することができる。以上の機能を取り込  
2 (open  
→  
んで作成したメインコードが である。  
open ) 1  
”servo 1.py”  
セキュリティを強化 コード  
2.5 (QR , NFC, RSA)  
今回は コードを用いた認証方式を実装していく。  
QR  
認証用 コードの生成  
• 任意の長QさRのパスワード アルファベット大文字小文字、数字、記号なし を生成し、それを  
コードに変換する。 コードの生成にはライブラリ を使用した。パスワー  
( )  
ド長によっては コードの コードの点の粗さ を調整する必要がある。また、  
QR QR ”pyqrcode”  
生成したパスワードがあとから参照できるよう、テキストファイルに保存する機構も用意  
QR version(QR )  
した。のちの認証の際に使用する。今回作成したコードは 内の  
に記述した。  
”module” ”pas gen2QR.py”  
認証用 コードの配布  
• 作成したQ認R証用 コードをユーザに配布するために今回は を利用した。  
のアカウントでログイン後、トークンを取得することで画像、テキストを送信することが  
QR LINENotify LINE  
できる。今回作成したコードは 内の に記述した。  
ここまでの認証用 コードの”生m成od、u配le”布を一”l体ine化.pしy”たものが である。  
QR ”send QR.py”  
コードの読み取り、認証  
• QラRイブラリ を使用して対象の画像データについて、 コードを読み取れたら値を  
返す関数を作成した。また、パスワードを列挙したテキストファイルを参照し、入力された値  
”pyzbar” QR  
が認証されたかを返す関数も作成した。今回作成したコードは 内の  
に記述した。  
”module” ”QR read.py”  
コードの撮影  
• Q予R定では のカメラモジュール を使用する予定だったが、現状  
Raspberry Pi ”Camera V2”  
6の環境では操作が不安定であったため、今回は使用を断念した。その代わりに で接続  
した カメラを用いることとした。使用するライブラリ の関係で写真撮影に  
USB  
関するコード部分は、 接続した状態では実行できないようなので、写真撮影を機構に  
Web ”opencv”  
含める際はリモートデスクトップやローカルで実行する必要がある。今回作成したコード  
SSH  
は 内の に記述した。  
”module” ”camera.py”  
以上の機能を取り込んで作成したメインコードが である。先ほど示した  
と比べ、 物理ボタン を追加した。これを押すことで カメラが起動し、 コードの読み  
”servo 2.py” ”servo 1.py”  
取りを開始する。認証されると(cid:20276)の開閉操作を実行する。実行手順としては  
” 2” Web QR  
を実行  
認証用 コードの配布  
1. ”send QR.py”  
QR  
を実行  
機能の開始  
2. ”Server.py”  
webAPI  
別のターミナルで を実行  
の操作を開始  
3. ”servo 2.py”  
RaspberryPi  
今回は実装しなかったが、 リーダーを使用した認証方式も同じような仕組みで実装できる  
と考えられる。  
NFC  
また、 コードの認証に公開(cid:20276)暗号を実装しようと 内に を作成した。情  
報工学実験のテーマ 暗号プロトコル実装 にて、 方式の公開(cid:20276)暗号を実装していたため、  
QR ”module” ”RSA.py”  
文字列にも対応できるように、秘密(cid:20276)、公開(cid:20276)をローカルに保存し再度暗号化できるよう関数を  
J” ” RSA  
改めた。単体のデバックで望む機能ができることは確認できたが、効果的な使い方を提案するこ  
とができなかったため、メインコードには採用しなかった。  
7実装の様子  
2.6  
実際に動作確認をした様子を示す。  
Raspherry Pi  
サーボモーター  
Webカメラ  
図 システムの全体像と  
5: LINE Notify  
を実行すると図 の右下のようにコメントと共に コードの画像が送信され  
る 図 の左下は各種部品の説明を示した。ボタンは左から物理ボタン と続き先に示した  
”send QR.py” 5 QR  
挙動を行う。 から を延長しブレッドボード上で配線を行った。  
. 5 1, 2, 3  
図 はデバックをしている様子である。自宅 上の画面左に開発環境 を、右側に  
Raspberry Pi GPIO  
のリモートデスクトップの画面を起動した。  
6 PC VSCode  
Raspberry Pi  
右側  
• 先に示: VしNたCよVうiewにeカr メラ操作を行うコード部分の実行は 接続状態では実行できないた  
め、 の実行はリモートデスクトップでローカルのターミナルで実行した。  
SSH  
”servo 2.py”  
左側  
• :接V続SCでo操de作  
SSH  
左下のターミナル  
– : ”Server.py”  
右下のターミナル  
(cid:20276)の開閉命令 へのデータ追加を間接的に実行  
– : ”sample.py”  
左上 開閉デー”タKeのyOロpグerand” 確認用の簡易的な ページ  
– 右上: カメラで撮影し”DたatスaMマoホdeにl”表示した コードWeb  
– : Web QR  
8図 動作確認の様子  
6:  
所感  
3  
実際に実装してみて、どの作業においても想定以上の作業工数がかかってしまった。 工数を  
コマ分の 分だとすると、 プリンターでのパーツ作成のための だけで 工数以上、  
1 1  
つまりは一週間分の作業量に相当する。コーディングにおいても役割ごとにモジュール分割して、  
90 3D 3DCAD 4  
デバックとともに進めていたため、何とか形にすることはできたが、なかなかハードなものだっ  
た。また同じようなことをやる際は、事前に工程表等を計画的に進めるべきで、プログラミング  
の大変さを実感した。  
今回やり残したことがいくつかある。  
の利用  
• s途la中ckまBoでt進めていたが、参考にした資料のバージョンが古いためかうまく連携できず途中  
で断念した  
との連携  
• I今F回TT、T他サービスとの連携は しか使用しなかった。構想段階では を  
介して 然り、他サービスとの連携を考えていたが、時間的な面で導入を断念し、と  
LINE Notefy IFTTT  
りあえずのシステムの完成を目指した  
LINE  
ドアへの取り付け  
• 実際にとりつけて(cid:20276)の開閉を行えることは確認したが、 カメラや、ボタンの扉自体へ  
の固定は行えなかった。理由として配線面の課題があった。使用した装置は貸し出しを受  
Web  
けているものであるため、あまり無理できないのに加え、電源を供給するための配線機材  
延長ケーブル等 が手元になかったため、この実験中では実装できなかった。 用に  
(cid:20276)開閉操作のコードを試作したのも、 にはバッテリーが内蔵されているため、なん  
( ) m5stick  
とかできるのではと考えていたためである。  
m5stick  
の利用  
• Heroku のサーバーをローカルで構築したが、時間があれば ページも工夫をし、簡易  
的ではない、しっかりとしたものを作りたかった。  
WebAPI Web  
9公開(cid:20276)暗号の利用  
• R何SかAに使えるのではと、せっかくコードを書き上げたが、有効活用できなかった。  
機会があればこの点をまた挑戦してみたい。  
しかし、始めてやることを試行錯誤しながら作り上げたことで大きな達成感を得ることができ  
た。 プリンターに関しても三重大学の に施設があるのは知っていたが、手を出せな  
いでいた。 の操作も初めは抵抗があったがなんとなく触っているうちに、設計方法を  
3D CeMDS  
学ぶことができたので、積極的に活用したいと思う。このスマートロックを自作する構想は以前  
Fusion360  
から持っていたが、なかなか行動に移すことができなかったため、よい機会だったと思う。  
参考文献  
で にリモートデスクトップ接続 対応  
[1] VNC Raspberry Pi (Windows/Mac/Linux ) - Indoor  
Corgi  
https://www.indoorcorgielec.com/resources/raspberry-pi/raspberry-pi-vnc/  
買ったらまず実施 のセキュリティ対策  
[2] ! RaspberryPi - Qiita  
https://qiita.com/c60evaporator/items/ebe9c6e8a445fed859dc  
から にカンタン 接続  
[3] Windows10 RaspberryPi SSH - Qiita  
https://qiita.com/c60evaporator/items/2384416f1122ae124f50#%E5%85%AC%E9%96%  
8B%E9%8D%B5%E8%AA%8D%E8%A8%BC%E3%81%AE%E5%A0%B4%E5%90%88%E6%89%8B%E9%A0%86  
から 接続をする方法  
[4] VSCode SSH — server-memo.net  
https://www.server-memo.net/memo/vscode/vscode_ssh.html  
―  
[5] API Documentation peewee 3.14.8 documentation  
https://docs.peewee-orm.com/en/latest/peewee/api.html  
10